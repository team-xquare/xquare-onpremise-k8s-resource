{{- if .Values.external.enabled }}
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: external-gateway
  namespace: {{ .Release.Namespace | default "default" }}
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-issuer
spec:
  gatewayClassName: cilium
  infrastructure:
    annotations:
      io.cilium/lb-ipam-ips: {{ .Values.external.ip }}
  listeners:
  - name: https
    port: 443
    protocol: HTTPS
    hostname: "*.dsmhs.kr"
    allowedRoutes:
      namespaces:
        from: All
    tls:
      mode: Terminate
      certificateRefs:
        - name: wildcard-dsmhs-tls
{{- end }}
---
# Hello World 애플리케이션 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-world
  labels:
    app: hello-world
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hello-world
  template:
    metadata:
      labels:
        app: hello-world
    spec:
      containers:
      - name: hello-world
        image: nginx:alpine
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        volumeMounts:
        - name: html-content
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html-content
        configMap:
          name: hello-world-html
---
# Hello World HTML 컨텐츠 ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: hello-world-html
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Hello World</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                text-align: center;
                margin-top: 100px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                min-height: 100vh;
                margin: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .container {
                background: rgba(255,255,255,0.1);
                padding: 40px;
                border-radius: 15px;
                backdrop-filter: blur(10px);
            }
            h1 {
                font-size: 3em;
                margin-bottom: 20px;
            }
            p {
                font-size: 1.2em;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>🌍 Hello World! 🌍</h1>
            <p>Cilium L2 LoadBalancer로 배포된 애플리케이션입니다!</p>
            <p>IP: 10.220.147.100</p>
        </div>
    </body>
    </html>
---
# LoadBalancer 타입 Service (특정 IP 할당)
apiVersion: v1
kind: Service
metadata:
  name: hello-world-service
  annotations:
    io.cilium/lb-ipam-ips: "10.220.147.100"  # Cilium에서 특정 IP 할당
spec:
  type: LoadBalancer
  selector:
    app: hello-world
  ports:
  - name: http
    port: 80
    targetPort: 80
    protocol: TCP
  loadBalancerIP: "10.220.147.100"  # 특정 IP 주소 요청